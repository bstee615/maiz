<html>
  <head> </head>
  <body>
    <input id="username" type="text" placeholder="username" />
    <button onclick="sendUsername()">Login</button>
    <button onclick="sendMove(-1, 0)">Left</button>
    <button onclick="sendMove(1, 0)">Right</button>

    <canvas id="maze" style="border: 1px solid black;"></canvas>
  </body>
  <script>
    var socket;

    function sendMove(x, y) {
      const username = document.getElementById("username").value;
      const delta = {
        x,
        y,
      };

      const cmd = {
        cmd: "move",
        username,
        delta,
      };
      socket.send(JSON.stringify(cmd));
    }

    function sendUsername() {
      const username = document.getElementById("username").value;

      socket = new WebSocket("ws://localhost:3000");

      socket.addEventListener("open", () => {
        const cmd = {
          cmd: "register",
          username,
        };

        socket.send(JSON.stringify(cmd));
      });

      socket.addEventListener("message", onMessage);
    }

    let players;
    function onMessage(msg) {
      console.log("message", msg);
      const data = JSON.parse(msg.data);
      console.log("data", data);
      switch (data.type) {
        case "initialize":
          players = data.players;
          drawCanvas(players);
          break;
        case "update":
          console.log("update", data.username, data.pos);
          players[data.username] = data.pos;
          drawCanvas(players);
          break;
      }
    }

    function drawCanvas(posByUsername) {
      const canvas = document.getElementById("maze");
      const context = canvas.getContext("2d");
      console.log(`Update positions`, posByUsername);
      context.clearRect(0, 0, canvas.width, canvas.height);

      for (var username in posByUsername) {
        const pos = posByUsername[username];
        context.beginPath();
        context.rect(pos.x, pos.y, 10, 10);
        context.stroke();
      }
    }
  </script>
</html>
